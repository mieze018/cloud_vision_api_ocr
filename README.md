# Cloud Vision API OCR

Google Cloud Vision API を使用した PDF / 画像 OCR デスクトップアプリケーションです。
数百ページ規模の PDF や画像ファイルを非同期バッチ処理で OCR し、Markdown 形式で出力します。

## 対応ファイル形式

| 形式   | 拡張子             | 処理方式           |
|------|-----------------|----------------|
| PDF  | `.pdf`          | 非同期バッチ（GCS 経由） |
| TIFF | `.tiff`, `.tif` | 非同期バッチ（GCS 経由） |
| GIF  | `.gif`          | 非同期バッチ（GCS 経由） |
| JPEG | `.jpg`, `.jpeg` | 同期処理（直接）       |
| PNG  | `.png`          | 同期処理（直接）       |

> **処理方式の違い**:
> - **非同期バッチ**: 大容量ファイル（数百ページの PDF 等）に対応。GCS にアップロード後、バックグラウンドで処理
> - **同期処理**: 単一画像を直接処理。GCS 不要で高速だが、大容量ファイルには不向き

## 目次

- [機能概要](#機能概要)
- [必要な環境](#必要な環境)
- [GCP の事前準備](#gcp-の事前準備)
  - [1. GCP プロジェクトの作成](#1-gcp-プロジェクトの作成)
  - [2. Cloud Vision API の有効化](#2-cloud-vision-api-の有効化)
  - [3. Cloud Storage バケットの作成](#3-cloud-storage-バケットの作成)
  - [4. サービスアカウントと認証キーの作成](#4-サービスアカウントと認証キーの作成)
- [インストールと起動](#インストールと起動)
- [アプリの使い方](#アプリの使い方)
  - [設定画面](#設定画面)
  - [OCR 処理の実行](#ocr-処理の実行)
- [設定項目の詳細](#設定項目の詳細)
- [ルビ除去機能（実験的）](#ルビ除去機能実験的)
- [改行整形機能（実験的）](#改行整形機能実験的)
- [処理フロー](#処理フロー)
- [トラブルシューティング](#トラブルシューティング)

---

## 機能概要

- **PDF / 画像対応**: PDF、JPEG、PNG、TIFF、GIF に対応
- **大容量ファイル対応**: 数百ページの PDF も非同期バッチ処理で OCR 可能
- **直感的な操作**: ドラッグ＆ドロップで簡単にファイルを選択
- **リアルタイム進捗表示**: 処理状況をログで確認
- **Markdown 出力**: 抽出したテキストを Markdown 形式で保存

---

## 必要な環境

- **Node.js**: v18 以上
- **Google Cloud Platform アカウント**: Vision API と Cloud Storage を使用
- **Windows / macOS / Linux**: クロスプラットフォーム対応

---

## GCP の事前準備

このアプリを使用するには、Google Cloud Platform (GCP) で以下の準備が必要です。

### 全体像

```
┌─────────────────────────────────────────────────────────────┐
│                    Google Cloud Platform                     │
│                                                             │
│  ┌─────────────────┐      ┌─────────────────────────────┐  │
│  │  Cloud Vision   │      │     Cloud Storage (GCS)     │  │
│  │      API        │      │                             │  │
│  │                 │      │  ┌─────────┐  ┌─────────┐   │  │
│  │  PDF/画像を    │◀────▶│  │ input/  │  │ output/ │   │  │
│  │  解析して抽出   │      │  │PDF/画像 │  │  JSON   │   │  │
│  │                 │      │  └─────────┘  └─────────┘   │  │
│  └─────────────────┘      └─────────────────────────────┘  │
│           ▲                           ▲                     │
│           │                           │                     │
│           │    サービスアカウント      │                     │
│           │    （認証キー JSON）       │                     │
│           └───────────────────────────┘                     │
└─────────────────────────────────────────────────────────────┘
                              ▲
                              │ API リクエスト
                              │
                    ┌─────────┴─────────┐
                    │   このアプリ       │
                    │  （ローカル PC）   │
                    └───────────────────┘
```

### 1. GCP プロジェクトの作成

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 画面上部のプロジェクト選択ドロップダウンをクリック
3. 「新しいプロジェクト」を選択
4. プロジェクト名を入力（例: `my-ocr-project`）して「作成」

### 2. Cloud Vision API の有効化

1. 作成したプロジェクトを選択
2. 左側メニューから「API とサービス」→「ライブラリ」を選択
3. 検索バーで「Cloud Vision API」を検索
4. 「Cloud Vision API」をクリックし、「有効にする」ボタンをクリック

### 3. Cloud Storage バケットの作成

Vision API の非同期バッチ処理では、PDF ファイルと処理結果を Cloud Storage (GCS) に保存する必要があります。

1. 左側メニューから「Cloud Storage」→「バケット」を選択
2. 「作成」ボタンをクリック
3. 以下を設定:
    - **バケット名**: グローバルで一意な名前（例: `my-ocr-bucket-001`）
   - **ロケーション**: `asia-northeast1`（東京）推奨
   - **ストレージクラス**: Standard
   - **アクセス制御**: 「均一」を選択
4. 「作成」をクリック

> **バケット名のルール**:
> - 小文字、数字、ハイフン、アンダースコアのみ使用可能
> - 3〜63 文字
> - 世界中で一意である必要があるため、ランダムな数字を付けるのがおすすめ

### 4. サービスアカウントと認証キーの作成

アプリが GCP にアクセスするための「認証キー」を作成します。

#### サービスアカウントの作成

1. 左側メニューから「IAM と管理」→「サービスアカウント」を選択
2. 「サービスアカウントを作成」をクリック
3. 以下を入力:
   - **サービスアカウント名**: `ocr-app`（任意）
   - **サービスアカウント ID**: 自動入力される
4. 「作成して続行」をクリック

#### 権限（ロール）の付与

サービスアカウントに以下のロールを付与します:

| ロール                     | 説明               |
|-------------------------|------------------|
| `Cloud Vision API ユーザー` | Vision API の使用権限 |
| `Storage オブジェクト管理者`     | GCS へのファイル読み書き権限 |

1. 「ロールを選択」で上記のロールを追加
2. 「続行」→「完了」をクリック

#### 認証キー（JSON）のダウンロード

1. 作成したサービスアカウントの行をクリック
2. 「キー」タブを選択
3. 「鍵を追加」→「新しい鍵を作成」をクリック
4. キーのタイプで「JSON」を選択し、「作成」
5. **JSON ファイルが自動的にダウンロードされます**

> ⚠️ **重要**: このキーファイルは機密情報です！
> - Git にコミットしない
> - 他人と共有しない
> - 安全な場所に保存する（例: `C:\Users\username\.gcp\keyfile.json`）

---

## インストールと起動

```bash
# リポジトリをクローン
git clone <repository-url>
cd cloud_vision_api_ocr

# 依存関係をインストール
npm install

# 開発モードで起動
npm run dev
```

### ビルド（配布用）
管理者権限で実行、releaseフォルダ内に作成される

```bash
# Windows 向けビルド
npm run build:win

# macOS 向けビルド
npm run build:mac

# Linux 向けビルド
npm run build:linux
```

---

## アプリの使い方

### 設定画面

アプリを起動したら、まず設定を行います。

1. 画面右上の **⚙️（設定アイコン）** をクリック
2. 設定画面が表示されます

    ```
    ┌─────────────────────────────────────────────┐
    │                   設定                       │
    ├─────────────────────────────────────────────┤
    │                                             │
    │  GCP認証キーファイルパス                     │
    │  ┌─────────────────────────────────────┐   │
    │  │ C:\Users\me\.gcp\keyfile.json       │   │
    │  └─────────────────────────────────────┘   │
    │                                             │
    │  GCSバケット名                              │
    │  ┌─────────────────────────────────────┐   │
    │  │ my-ocr-bucket-12345                 │   │
    │  └─────────────────────────────────────┘   │
    │                                             │
    │  出力先ディレクトリ                          │
    │  ┌─────────────────────────────────────┐   │
    │  │ C:\Users\me\Documents               │   │
    │  └─────────────────────────────────────┘   │
    │                                             │
    │  ポーリング間隔（ミリ秒）                    │
    │  ┌─────────────────────────────────────┐   │
    │  │ 10000                               │   │
    │  └─────────────────────────────────────┘   │
    │                                             │
    │              [ 保存 ]  [ キャンセル ]        │
    └─────────────────────────────────────────────┘
    ```

3. 各項目を入力して「保存」をクリック

### OCR 処理の実行

1. 設定完了後、メイン画面に戻ります
2. PDF または画像ファイルを **ドラッグ＆ドロップ** するか、クリックしてファイルを選択
3. 処理が自動的に開始され、進捗がログに表示されます
4. 完了すると、指定した出力先に Markdown ファイルが生成されます

---

## 設定項目の詳細

| 項目                | 説明                                                 | 例                               |
|-------------------|----------------------------------------------------|---------------------------------|
| **GCP認証キーファイルパス** | [手順4](#4-サービスアカウントと認証キーの作成) でダウンロードした JSON ファイルのパス | `C:\Users\me\.gcp\keyfile.json` |
| **GCSバケット名**      | [手順3](#3-cloud-storage-バケットの作成) で作成したバケットの名前       | `my-ocr-bucket-12345`           |
| **出力先ディレクトリ**     | 生成される Markdown ファイルの保存先                            | `C:\Users\me\Documents`         |
| **ポーリング間隔**       | Vision API の処理完了を確認する間隔（ミリ秒）。通常は 10000（10秒）で OK    | `10000`                         |
| **ルビを除去する**       | 日本語 PDF のルビ（振り仮名）を除去する（実験的機能）                      | チェックボックス                        |
| **改行を段落単位で整形する**  | OCR 結果の改行を段落単位で整形する（実験的機能）                         | チェックボックス                        |

### 設定の保存場所

設定は以下のファイルに保存されます:

- **Windows**: `%USERPROFILE%\.cloud-vision-ocr\config.json`
- **macOS / Linux**: `~/.cloud-vision-ocr/config.json`

---

## ルビ除去機能（実験的）

日本語の PDF を OCR すると、ルビ（振り仮名）が本文に混じって出力されることがあります。

```
例：
OCR結果（ルビあり）: 「私わたしは学校がっこうに行いきます」
OCR結果（ルビなし）: 「私は学校に行きます」
```

### 使い方

1. 設定画面で「ルビ（振り仮名）を除去する」にチェックを入れる
2. 通常通り PDF を処理する

### 仕組み

Vision API は文字ごとの位置情報（bounding box）を返します。この機能では：

1. 各ブロック内の文字高さの中央値を計算（本文サイズの推定）
2. 中央値の 60% 未満の高さの文字をルビとして除去
3. 改行・スペースの情報を維持しながらテキストを再構築

### 注意事項

> ⚠️ **実験的機能です**
>
> - 完璧な除去は難しく、誤検出の可能性があります
> - 小さい記号や注釈も除去される場合があります
> - 効果は PDF のレイアウトやフォントに依存します
> - 非同期バッチ処理（PDF, GIF, TIFF）でのみ有効です

---

## 改行整形機能（実験的）

OCR 結果は、PDF や画像の「見た目のレイアウト」に基づいて改行されます。
そのため、文章の途中で不自然な改行が入ることがあります。

```
例：
OCR結果（整形前）:
「今日は天気が
良いので公園に
散歩に行きました。」

OCR結果（整形後）:
「今日は天気が良いので公園に散歩に行きました。」
```

### 使い方

1. 設定画面で「改行を段落単位で整形する」にチェックを入れる
2. 通常通り PDF / 画像を処理する

### 仕組み

Vision API は段落（paragraph）単位でテキストを認識します。この機能では：

1. 段落内の改行（LINE_BREAK）を除去し、テキストを連結
2. 段落間は空行（2つの改行）で区切り
3. スペース（SPACE, SURE_SPACE）は維持

```
┌─────────────────────────────────────────┐
│  Vision API が認識する構造               │
├─────────────────────────────────────────┤
│                                         │
│  Block（ブロック）                       │
│    └─ Paragraph（段落）← この単位で結合  │
│         └─ Word（単語）                 │
│              └─ Symbol（文字）          │
│                   └─ LINE_BREAK ← 除去  │
│                                         │
└─────────────────────────────────────────┘
```

### 注意事項

> ⚠️ **実験的機能です**
>
> - 元のレイアウト情報（行の区切り位置）は失われます
> - 詩や箇条書きなど、意図的な改行も除去される場合があります
> - 表形式のテキストは崩れる可能性があります
> - ルビ除去機能と併用可能です

---

## 処理フロー

```
┌──────────────────────────────────────────────────────────────┐
│                        処理フロー                             │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 初期化                                                    │
│     └─ GCS・Vision API の接続確認                            │
│                           ↓                                  │
│  2. アップロード                                              │
│     └─ PDF/画像を GCS の input/ フォルダにアップロード        │
│                           ↓                                  │
│  3. OCR リクエスト                                            │
│     └─ Vision API に非同期バッチ処理をリクエスト              │
│                           ↓                                  │
│  4. ポーリング                                                │
│     └─ 処理完了まで定期的にステータスを確認                   │
│                           ↓                                  │
│  5. ダウンロード                                              │
│     └─ GCS から JSON 結果ファイルをダウンロード               │
│                           ↓                                  │
│  6. 変換                                                      │
│     └─ JSON を Markdown 形式に変換                           │
│                           ↓                                  │
│  7. 保存                                                      │
│     └─ Markdown ファイルをローカルに保存                      │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## トラブルシューティング

### よくあるエラーと対処法

| エラー                        | 原因                         | 対処法                                      |
|----------------------------|----------------------------|------------------------------------------|
| `E002: GCP 認証失敗`           | キーファイルが見つからない、または無効        | キーファイルのパスが正しいか確認。ファイルが存在するか確認            |
| `E101: バケットが見つからない`        | バケット名が間違っている               | GCS コンソールでバケット名を確認し、設定を修正                |
| `E102: アップロード失敗`           | 権限不足                       | サービスアカウントに「Storage オブジェクト管理者」ロールがあるか確認   |
| `E201: Vision API リクエスト失敗` | API が有効化されていない             | GCP コンソールで Cloud Vision API が有効になっているか確認 |
| `E202: タイムアウト`             | PDF が大きすぎる、または処理に時間がかかっている | ポーリング間隔を長くして再試行                          |

### ログの確認

詳細なログは以下のファイルに保存されます:

- **Windows**: `%USERPROFILE%\.cloud-vision-ocr\logs\app.log`
- **macOS / Linux**: `~/.cloud-vision-ocr/logs/app.log`

### GCP の課金について

- **Cloud Vision API**: 月 1,000 ユニットまで無料
- **Cloud Storage**: 月 5GB まで無料

詳細は [Google Cloud 料金計算ツール](https://cloud.google.com/products/calculator) を参照してください。

---

## ライセンス

MIT License
